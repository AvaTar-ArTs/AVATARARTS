<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heavenly Hands Call Tracking Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        margin: 0;
        font-size: 2.5em;
      }

      .header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        padding: 30px;
        background: #f8f9fa;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #3498db;
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #7f8c8d;
        font-size: 0.9em;
      }

      .charts-section {
        padding: 30px;
      }

      .chart-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
      }

      .chart-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .chart-title {
        font-size: 1.2em;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 15px;
        text-align: center;
      }

      .recent-leads {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .leads-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      .leads-table th,
      .leads-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      .leads-table th {
        background: #f8f9fa;
        font-weight: bold;
        color: #2c3e50;
      }

      .leads-table tr:hover {
        background: #f8f9fa;
      }

      .booking-badge {
        background: #27ae60;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
      }

      .no-booking-badge {
        background: #e74c3c;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

    </style>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1>üè† Heavenly Hands Call Tracking</h1>
        <p>Production-Ready Call Analytics Dashboard</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="total-leads">0</div>
          <div class="stat-label">Total Leads</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="successful-bookings">0</div>
          <div class="stat-label">Successful Bookings</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="conversion-rate">0%</div>
          <div class="stat-label">Conversion Rate</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="active-sources">0</div>
          <div class="stat-label">Active Lead Sources</div>
        </div>
      </div>

      <div class="charts-section">
        <div class="chart-container">
          <div class="chart-card">
            <div class="chart-title">üìä Leads by Source</div>
            <canvas id="leadsBySource"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-title">üèôÔ∏è Leads by City</div>
            <canvas id="leadsByCity"></canvas>
          </div>
        </div>

        <div class="chart-container">
          <div class="chart-card">
            <div class="chart-title">üîß Leads by Service Type</div>
            <canvas id="leadsByService"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-title">üìà Conversion Rates by Source</div>
            <canvas id="conversionRates"></canvas>
          </div>
        </div>
      </div>

      <div class="recent-leads">
        <h2>üìû Recent Leads</h2>
        <div id="recent-leads-content">
          <div class="loading">
            <div class="spinner"></div>
            Loading recent leads...
          </div>
        </div>
      </div>
    </div>

    <script>
      // Make all charts responsive
      Chart.defaults.global.responsive = true;
      Chart.defaults.global.maintainAspectRatio = false;

      // Load dashboard data
      function loadDashboardData() {
        // Load leads by source
        $.get("/api/leads-by-source", function (data) {
          if (data.length > 0) {
            var chartData = [];
            var colors = ['#3498db', '#e74c3c', '#27ae60', '#f39c12', '#9b59b6', '#1abc9c'];

            for (var i = 0; i < data.length; i++) {
              chartData.push({
                value: data[i]['lead__count'],
                label: data[i]['name'] || 'Unnamed Source',
                color: colors[i % colors.length]
              });
            }

            var ctx = document.getElementById("leadsBySource").getContext("2d");
            new Chart(ctx, {
              type: 'pie',
              data: {
                datasets: [{
                  data: chartData.map(item => item.value),
                  backgroundColor: chartData.map(item => item.color)
                }],
                labels: chartData.map(item => item.label)
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    position: 'bottom'
                  }
                }
              }
            });
          }
        });

        // Load leads by city
        $.get("/api/leads-by-city", function (data) {
          if (data.length > 0) {
            var chartData = [];
            var colors = ['#3498db', '#e74c3c', '#27ae60', '#f39c12', '#9b59b6'];

            for (var i = 0; i < data.length; i++) {
              chartData.push({
                value: data[i]['id__count'],
                label: data[i]['city'] || 'Unknown',
                color: colors[i % colors.length]
              });
            }

            var ctx = document.getElementById("leadsByCity").getContext("2d");
            new Chart(ctx, {
              type: 'doughnut',
              data: {
                datasets: [{
                  data: chartData.map(item => item.value),
                  backgroundColor: chartData.map(item => item.color)
                }],
                labels: chartData.map(item => item.label)
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    position: 'bottom'
                  }
                }
              }
            });
          }
        });

        // Load leads by service type
        $.get("/api/leads-by-service", function (data) {
          if (data.length > 0) {
            var chartData = [];
            var colors = ['#3498db', '#e74c3c', '#27ae60', '#f39c12', '#9b59b6', '#1abc9c'];

            for (var i = 0; i < data.length; i++) {
              chartData.push({
                value: data[i]['id__count'],
                label: data[i]['service_type'] || 'Unknown',
                color: colors[i % colors.length]
              });
            }

            var ctx = document.getElementById("leadsByService").getContext("2d");
            new Chart(ctx, {
              type: 'bar',
              data: {
                labels: chartData.map(item => item.label),
                datasets: [{
                  label: 'Number of Leads',
                  data: chartData.map(item => item.value),
                  backgroundColor: chartData.map(item => item.color)
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    display: false
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true
                  }
                }
              }
            });
          }
        });

        // Load conversion rates
        $.get("/api/conversion-rates", function (data) {
          if (data.length > 0) {
            var chartData = [];
            var colors = ['#27ae60', '#e74c3c', '#f39c12', '#3498db', '#9b59b6'];

            for (var i = 0; i < data.length; i++) {
              chartData.push({
                value: data[i]['conversion_rate'],
                label: data[i]['name'] || 'Unnamed Source',
                color: colors[i % colors.length]
              });
            }

            var ctx = document.getElementById("conversionRates").getContext("2d");
            new Chart(ctx, {
              type: 'bar',
              data: {
                labels: chartData.map(item => item.label),
                datasets: [{
                  label: 'Conversion Rate (%)',
                  data: chartData.map(item => item.value),
                  backgroundColor: chartData.map(item => item.color)
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    display: false
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    max: 100
                  }
                }
              }
            });
          }
        });

        // Load recent leads
        $.get("/api/recent-leads", function (data) {
          var container = document.getElementById('recent-leads-content');

          if (data.length === 0) {
            container.innerHTML = '<p>No recent leads found.</p>';
            return;
          }

          var html = '<table class="leads-table"><thead><tr><th>Customer</th><th>Phone</th><th>City</th><th>Service</th><th>Source</th><th>Time</th><th>Booking</th></tr></thead><tbody>';

          data.forEach(function (lead) {
            var bookingBadge = lead.booking_made ?
              '<span class="booking-badge">Booked</span>' :
              '<span class="no-booking-badge">No Booking</span>';

            html += '<tr>';
            html += '<td>' + (lead.customer_name || 'Unknown') + '</td>';
            html += '<td>' + lead.phone_number + '</td>';
            html += '<td>' + lead.city + '</td>';
            html += '<td>' + lead.service_type + '</td>';
            html += '<td>' + lead.source_name + '</td>';
            html += '<td>' + new Date(lead.timestamp).toLocaleString() + '</td>';
            html += '<td>' + bookingBadge + '</td>';
            html += '</tr>';
          });

          html += '</tbody></table>';
          container.innerHTML = html;
        });

        // Load summary statistics
        $.get("/api/analytics", function (data) {
          if (data.booking_conversions) {
            document.getElementById('total-leads').textContent = data.booking_conversions.total_leads;
            document.getElementById('successful-bookings').textContent = data.booking_conversions.successful_bookings;
            document.getElementById('conversion-rate').textContent = data.booking_conversions.conversion_rate + '%';
          }

          if (data.leads_per_source) {
            document.getElementById('active-sources').textContent = data.leads_per_source.length;
          }
        });
      }

      // Load dashboard on page load
      $(document).ready(function () {
        loadDashboardData();

        // Refresh data every 30 seconds
        setInterval(loadDashboardData, 30000);
      });
    </script>
  </body>

</html>
